const mongoose = require('mongoose');
const { Schema } = mongoose;
const mongooseLeanVirtuals = require('mongoose-lean-virtuals');

const BidSchema = new Schema(
  {
    _bidderRef: {
      type: Schema.Types.ObjectId,
      ref: 'UserModel',
      required: true,
    },
    _jobRef: { type: Schema.Types.ObjectId, ref: 'JobModel', required: true }, //we will use this to reference the job
    state: {
      type: String,
      enum: [
        'OPEN',
        'CANCELED_AWARDED_BY_TASKER',
        'CANCELED_AWARDED_BY_REQUESTER',
        'WON', // when Tasker is awarded
        'WON_SEEN', // when tasker seen the awarded bid
        'DONE', // when Requester confirms job is done
        'PAID_OUT', // When we issue release of funds
        'ARCHIVED', // when stripe webhook infroms us that funds were recieved in thier bank
      ],
      default: 'OPEN',
    },
    isNewBid: { type: Boolean, default: true }, // will be used to highlight unseen bids
    bidAmount: {
      value: { type: Number, required: true },
      currency: {
        type: String,
        enum: ['CAD', 'USD'],
        default: 'CAD',
      },
    }, //dolar amount
    extras: { type: Object },
  },
  { timestamps: true } // createdAt and updatedAt auto  generated by mongoose
);

BidSchema.virtual('displayStatus').get(function() {
  const stateToDisplayName = {
    OPEN: 'Awaiting On Requester',
    WON: 'Winning Bid',
    WON_SEEN: 'Winning Bid',
    CANCELED_AWARDED_BY_REQUESTER: 'Requester Cancelled the Agreement',
    CANCELED_AWARDED_BY_TASKER: 'Tasker Cancelled the Agreement',
    DONE: 'Task is Completed',
    PAID_OUT: 'Paid out to Tasker',
  };
  return stateToDisplayName[this.state];
});
BidSchema.plugin(mongooseLeanVirtuals);

//no need for index on these . avoid performance slowness
mongoose.model('BidModel', BidSchema);
